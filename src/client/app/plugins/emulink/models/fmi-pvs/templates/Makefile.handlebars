CC=gcc
CFLAGS=-I.

%.o: %.c
	$(CC) -c -o $@ $< $(CFLAGS)
all:
	gcc -fPIC -Wall -c fmu.c
	gcc -fPIC -Wall -c skeleton.c
	gcc -fPIC -Wall -c misraC/{{name}}.c
	{{#if portCheck}}unzip -o resources/libWS.zip
	gcc -fPIC -shared -o {{name}}.so skeleton.o fmu.o {{name}}.o -Wl,-rpath,. -L. -lwebsockets {{#if timeCheck}}-lm{{/if}}
	{{else}}unzip -o resources/lib.zip
	gcc -shared -o {{name}}.so skeleton.o fmu.o {{name}}.o {{#if timeCheck}}-lm{{/if}}{{/if}}
	rm -rf sources
	rm -rf binaries
	mkdir sources
	mkdir  binaries
	mkdir binaries/linux64
	cp fmu.h sources
	cp FmuGUID.h sources
	cp fmu.c sources
	cp skeleton.c sources
	rm -f misraC/main.c
	cp -r misraC sources
	cp -r fmi sources
	mv {{name}}.so binaries/linux64/
	{{#if portCheck}}cp libwebsockets.* binaries/linux64/
	cp libcrypto.so.* binaries/linux64/
	cp libssl.so.* binaries/linux64/{{/if}}
	zip -r {{name}}.fmu modelDescription.xml binaries/ resources/ sources/
	rm -rf sources
	rm -rf binaries
	{{#if portCheck}}rm libwebsockets.*
	rm libcrypto.so.*
	rm libssl.so.*{{/if}}

run:
	{{#if portCheck}}unzip -o resources/libWS.zip{{/if}}
	./fmuCheck.linux64 -h 1E-01 {{name}}.fmu
	{{#if portCheck}}rm libwebsockets.*
	rm libcrypto.so.*
	rm libssl.so.*{{/if}}
run1:
	{{#if portCheck}}unzip -o resources/libWS.zip{{/if}}
	./fmuCheck.linux64 -h 1E-02 {{name}}.fmu
	{{#if portCheck}}rm libwebsockets.*
	rm libcrypto.so.*
	rm libssl.so.*{{/if}}

clean:
	rm -rf  {{name}}.o fmu.o skeleton.o
